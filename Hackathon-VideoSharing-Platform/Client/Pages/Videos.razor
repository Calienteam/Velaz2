@page "/videos"

@using Hackathon_VideoSharing_Platform.Shared
@using Microsoft.AspNetCore.SignalR.Client
@using IPFSConnection

@inject NavigationManager NavigationManager

<h3>Available Videos</h3>
@if (IsSending)
{
    <p>Loading...</p>
}
else
{
    @foreach (var video in videos)
    {
        <div class="embed-responsive embed-responsive-21by9">
            <iframe class="embed-responsive-item" src="@dict[video.IPFSHash]"></iframe>
        </div>
        <div>Title: @video.Title</div>
        <div>Price: @video.Price</div>
        <button class="btn btn-primary" @onclick="buyVideo">Buy</button>
    }
}



@code {
    private HubConnection hubConnection;
    private IPFSConnection IPFSConnection = new IPFSConnection();
    private string videoByteString;
    private bool IsSending;
    private List<VideoMetaData> videos = new List<VideoMetaData>
{
        new VideoMetaData() { Title = "First video", Price = 10, IPFSHash = "QmbTMj5bBMyHzFE7HTMBqnsuC58rv6q7Zai8BAiMtRqFT7" },
    };

    private Dictionary<string, string> dict = new Dictionary<string, string>();

    protected override async Task OnInitializedAsync()
    {
        IsSending = true;
        foreach (var item in videos)
        {
            var videoByteString = await VideoUrl(item.IPFSHash);
            dict.Add(item.IPFSHash, videoByteString);
        }
        IsSending = false;
        hubConnection = new HubConnectionBuilder()
        .WithUrl(NavigationManager.ToAbsoluteUri("/notificationhub"))
        .Build();

        hubConnection.On<VideoMetaData>("OnBroadcastNewVideoInfo", (video) =>
        {
            videos.Add(video);
            this.StateHasChanged();
        });

        await hubConnection.StartAsync();
    }
    protected async Task<string> VideoUrl(string str)
    {
        string result = "data:video/mp4;base64,";
        var video = await IPFSConnection.GetVideoData64(str);
        string ipfsVideo = Convert.ToBase64String(video);
        return result + ipfsVideo;
    }

    public void buyVideo()
    {


    }
}
